# é•¿ç¯‡å°è¯´å¤„ç†ç³»ç»Ÿé‡æ„ - v3.0 å‘é‡åŒ–è®°å¿†ç‰ˆ

> ğŸ“‹ æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº† 2026-02-20 è¿›è¡Œçš„ç³»ç»Ÿæ¶æ„é‡æ„ï¼Œè§£å†³é•¿ç¯‡å°è¯´å¤„ç†ä¸­çš„ä¸‰å¤§æ ¸å¿ƒé—®é¢˜

---

## ğŸ“Œ é‡æ„èƒŒæ™¯

### é—®é¢˜åˆ†æï¼ˆæ¥è‡ª no03.md çš„ä¸¥å‰ç‚¹è¯„ï¼‰

è™½ç„¶ç³»ç»Ÿæ¡†æ¶æ­å¾—æ¼‚äº®ï¼Œä½†å¦‚æœçœŸçš„æ‹¿å»è·‘ä¸€æœ¬ 300 ä¸‡å­—çš„ã€Šä¿®çœŸå°è¯´ã€‹ï¼Œç³»ç»Ÿä¾ç„¶ä¼šé¢ä¸´ä»¥ä¸‹å‡ ä¸ªä¸¥å³»æŒ‘æˆ˜ï¼š

#### âŒ é—®é¢˜ 1ï¼šè®°å¿†è†¨èƒ€å¯¼è‡´ä¸Šä¸‹æ–‡çˆ†ç‚¸ (Context Bloat Risk)

åœ¨ `MemoryBank.to_context_prompt()` ä¸­ï¼ŒæŠŠæ‰€æœ‰äººç‰©ã€å…³ç³»çš„æ‘˜è¦ç›´æ¥å¡è¿›äº†ä¸‹ä¸€æ¬¡è¯·æ±‚çš„ Prompt é‡Œã€‚å¦‚æœå°è¯´é‡Œå‡ºç°äº† 200 ä¸ªäººç‰©ï¼Œè¿™ä¸ª Prompt ä¼šè¶Šæ¥è¶Šé•¿ï¼Œæœ€ç»ˆä¾ç„¶ä¼šæ’‘çˆ† Token é™åˆ¶ï¼Œæˆ–è€…å¯¼è‡´å¤§æ¨¡å‹"æ³¨æ„åŠ›æ¶£æ•£ï¼ˆLost in the middleï¼‰"ã€‚

**æ­£ç¡®åšæ³•**ï¼šåº”è¯¥å¼•å…¥å‘é‡æ•°æ®åº“ï¼ˆVector DBï¼‰ï¼Œåœ¨å¤„ç†æ–°ç« èŠ‚æ—¶ï¼Œåªæ£€ç´¢å‡ºæœ¬ç« æåˆ°çš„äººç‰©çš„å†å²è®°å¿†ã€‚

#### âŒ é—®é¢˜ 2ï¼šç”Ÿæˆæ¨¡å—"å¤±å¿†"ï¼ˆä¸Šä¸‹æ–‡æ–­è£‚ï¼‰

æœ€ä¸¥é‡çš„è®¾è®¡ç¼ºé™·ï¼šæå–æ¨¡å—ï¼ˆExtractorï¼‰ç”¨åˆ°äº† MemoryBankï¼Œä½†æ˜¯å‰§æœ¬ç”Ÿæˆï¼ˆScriptï¼‰å’Œåˆ†é•œç”Ÿæˆï¼ˆStoryboardï¼‰æ¨¡å—æ ¹æœ¬æ²¡æœ‰ä½¿ç”¨è®°å¿†ï¼

ç»“æœå°±æ˜¯ï¼šå¦‚æœç¬¬ä¸€ç« äº¤ä»£äº†ä¸»è§’ç©¿çº¢è¡£æœï¼Œç¬¬åç« å‘ç”Ÿæ‰“æ–—ã€‚ç¬¬åç« çš„åˆ†é•œç”Ÿæˆå™¨å› ä¸ºçœ‹ä¸åˆ°ç¬¬ä¸€ç« çš„è®°å¿†ï¼Œå®ƒæ ¹æœ¬ä¸çŸ¥é“ä¸»è§’é•¿ä»€ä¹ˆæ ·ã€‚åˆ†é•œçš„è¿ç»­æ€§å°±è¢«ç ´åäº†ã€‚

#### âŒ é—®é¢˜ 3ï¼šç¼ºä¹ç½‘ç»œå®¹é”™ä¸é‡è¯•æœºåˆ¶ (Lack of Retry Mechanism)

ä»£ç ä¸­ç›´æ¥è°ƒç”¨äº† `client.chat.completions.create`ã€‚åœ¨è·‘é•¿ç¯‡å°è¯´æ—¶ï¼ˆå¯èƒ½è¦è¿ç»­è¯·æ±‚ API å‡ ç™¾æ¬¡ï¼‰ï¼Œæå…¶å®¹æ˜“é‡åˆ°å„å¤§æ¨¡å‹å‚å•†çš„é™æµï¼ˆHTTP 429ï¼‰æˆ–ç½‘ç»œæ³¢åŠ¨æŠ¥é”™ã€‚ä»£ç ä¸­æ²¡æœ‰ä»»ä½•ç±»ä¼¼ Tenacity çš„æŒ‡æ•°é€€é¿é‡è¯•é€»è¾‘ï¼Œä¸€æ—¦æŠ¥é”™ï¼Œç¨‹åºå°±ç›´æ¥æŠ›å¼‚å¸¸æ­»æ‰äº†ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆä¸å®ç°

### æ–¹æ¡ˆ 1ï¼šå‘é‡åŒ–è®°å¿†æ£€ç´¢ç³»ç»Ÿ

#### æ–°å¢æ¨¡å—ï¼š`vector_store.py`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VectorMemoryBank                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  + CharacterMemoryStore    (äººç‰©è®°å¿†å‘é‡å­˜å‚¨)               â”‚
â”‚  + SimpleTfidfVectorizer   (è½»é‡çº§ TF-IDF å‘é‡åŒ–å™¨)          â”‚
â”‚  + cosine_similarity       (ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒåŠŸèƒ½ï¼š**

| ç±»/æ–¹æ³• | åŠŸèƒ½è¯´æ˜ |
|---------|----------|
| `SimpleTfidfVectorizer` | æ— éœ€å¤–éƒ¨ä¾èµ–çš„ TF-IDF å‘é‡åŒ–å™¨ï¼Œæ”¯æŒä¸­æ–‡ 2-gram åˆ†è¯ |
| `CharacterMemoryStore` | äººç‰©è®°å¿†å‘é‡å­˜å‚¨ï¼Œæ”¯æŒé«˜æ•ˆçš„è¯­ä¹‰æ£€ç´¢ |
| `VectorMemoryBank` | æ•´åˆå‘é‡æ£€ç´¢å’Œä¼ ç»Ÿè®°å¿†ç®¡ç†çš„ç»Ÿä¸€æ¥å£ |
| `retrieve_relevant_characters(text, top_k)` | ä»æ–‡æœ¬ä¸­æ£€ç´¢æœ€ç›¸å…³çš„äººç‰© |
| `build_context(text, max_characters)` | ä¸ºç»™å®šæ–‡æœ¬æ„å»ºç›¸å…³çš„ä¸Šä¸‹æ–‡è®°å¿† |

**å·¥ä½œæµç¨‹ï¼š**

```
æ–°ç« èŠ‚æ–‡æœ¬è¾“å…¥
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘é‡æ£€ç´¢å¼•æ“     â”‚ â† è®¡ç®—ä¸æ‰€æœ‰äººç‰©è®°å¿†çš„ç›¸ä¼¼åº¦
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Top-K ç›¸å…³äººç‰©   â”‚ â† åªè¿”å›æœ€ç›¸å…³çš„ 3-5 ä¸ªäººç‰©
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”Ÿæˆç²¾ç®€ä¸Šä¸‹æ–‡   â”‚ â† ä»…åŒ…å«ç›¸å…³äººç‰©çš„è®°å¿†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
  ä¼ é€’ç»™ LLM Prompt
```

**ä»£ç ç¤ºä¾‹ï¼š**

```python
from vector_store import VectorMemoryBank

# åˆ›å»ºè®°å¿†é“¶è¡Œ
memory_bank = VectorMemoryBank()

# æ·»åŠ äººç‰©ï¼ˆå‘é‡åŒ–å­˜å‚¨ï¼‰
memory_bank.add_character(
    character_id='char_harry',
    name='å“ˆåˆ©Â·æ³¢ç‰¹',
    traits=['å‹‡æ•¢', 'å†²åŠ¨', 'å¿ è¯š'],
    goals=['æ‰“è´¥ä¼åœ°é­”', 'ä¿æŠ¤æœ‹å‹'],
    descriptions=['å¹´è½»çš„å·«å¸ˆ', 'éœæ ¼æ²ƒèŒ¨å­¦ç”Ÿ'],
    appearances=['é»‘è‰²å¤´å‘', 'ç»¿è‰²çœ¼ç›', 'é¢å¤´æœ‰é—ªç”µä¼¤ç–¤']
)

# æ£€ç´¢ç›¸å…³äººç‰©ï¼ˆåªè¿”å›ä¸å½“å‰æ–‡æœ¬ç›¸å…³çš„ï¼‰
relevant_chars = memory_bank.retrieve_relevant_characters(
    text='å“ˆåˆ©æ‹”å‡ºæ ¼å…°èŠ¬å¤šå®å‰‘ä¸æ€ªç‰©æˆ˜æ–—',
    top_k=3
)
# è¾“å‡ºï¼š['char_harry']

# æ„å»ºç²¾ç®€çš„ä¸Šä¸‹æ–‡
context = memory_bank.to_context_prompt(
    current_text='å“ˆåˆ©ä¸æ€ªç‰©æˆ˜æ–—'
)
```

---

### æ–¹æ¡ˆ 2ï¼šä¸ºç”Ÿæˆæ¨¡å—æ³¨å…¥è®°å¿†

#### ä¿®æ”¹æ¨¡å—ï¼š`script_generator.py` å’Œ `storyboard_generator.py`

**ä¿®æ”¹å‰ï¼š**

```python
class ScriptGenerator:
    def __init__(self, llm_client):
        self.llm_client = llm_client

    def generate(self, events):
        # æ²¡æœ‰ä½¿ç”¨ä»»ä½•è®°å¿†ä¸Šä¸‹æ–‡
        for event in events:
            scene = self._create_scene_from_event(event)
```

**ä¿®æ”¹åï¼š**

```python
class ScriptGenerator:
    def __init__(self, llm_client, memory_bank=None):
        self.llm_client = llm_client
        self.memory_bank = memory_bank  # æ”¯æŒè®°å¿†é“¶è¡Œæ³¨å…¥

    def generate(self, events, memory_context=None):
        # æ³¨å…¥è®°å¿†ä¸Šä¸‹æ–‡åˆ° Prompt
        for event in events:
            scene = self._create_scene_from_event(
                event,
                memory_context=memory_context
            )
```

**Prompt æ³¨å…¥ç¤ºä¾‹ï¼š**

```python
# åŸå§‹ Prompt
prompt = SCENE_GENERATION_PROMPT.format(...)

# æ³¨å…¥è®°å¿†åçš„ Prompt
if memory_context:
    prompt = f"""ä»¥ä¸‹æ˜¯ç›¸å…³äººç‰©çš„è®°å¿†ä¿¡æ¯ï¼Œè¯·åœ¨ç”Ÿæˆå‰§æœ¬æ—¶å‚è€ƒè¿™äº›ä¿¡æ¯æ¥ä¿æŒäººç‰©çš„ä¸€è‡´æ€§ï¼š

{memory_context}

{SCENE_GENERATION_PROMPT.format(...)}
"""
```

**æ•ˆæœå¯¹æ¯”ï¼š**

| åœºæ™¯ | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| ç¬¬ 1 ç« ï¼šä¸»è§’ç™»åœº | çŸ¥é“ä¸»è§’é»‘å‘ç»¿çœ¼ | çŸ¥é“ä¸»è§’é»‘å‘ç»¿çœ¼ âœ“ |
| ç¬¬ 10 ç« ï¼šä¸»è§’æˆ˜æ–— | âŒ ä¸çŸ¥é“ä¸»è§’å¤–è²Œ | âœ“ é€šè¿‡å‘é‡æ£€ç´¢è·å–ä¸»è§’è®°å¿† |
| ç¬¬ 50 ç« ï¼šæ–°è§’è‰²åŠ å…¥ | âŒ ä¸ä¹‹å‰äººç‰©å…³ç³»æ··ä¹± | âœ“ æ¸…æ¥šæ‰€æœ‰äººç‰©çš„å…³ç³»ç½‘ç»œ |

---

### æ–¹æ¡ˆ 3ï¼šAPI é‡è¯•æœºåˆ¶

#### ä¿®æ”¹æ¨¡å—ï¼š`extractor.py`, `script_generator.py`, `storyboard_generator.py`

**é‡è¯•ç­–ç•¥ï¼š**

```
è¯·æ±‚å¤±è´¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ¤æ–­é”™è¯¯ç±»å‹    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€ HTTP 429 (é™æµ) â”€â”€â†’ æŒ‡æ•°é€€é¿ç­‰å¾… â”€â”€â†’ é‡è¯•
    â”œâ”€ HTTP 5xx (æœåŠ¡å™¨é”™è¯¯) â†’ æŒ‡æ•°é€€é¿ç­‰å¾… â”€â”€â†’ é‡è¯•
    â”œâ”€ Connection Error â”€â”€â†’ æŒ‡æ•°é€€é¿ç­‰å¾… â”€â”€â†’ é‡è¯•
    â””â”€ HTTP 4xx (å®¢æˆ·ç«¯é”™è¯¯) â”€â”€â†’ ç›´æ¥æŠ›å‡ºï¼Œä¸é‡è¯•
```

**å®ç°ä»£ç ï¼š**

```python
class OpenAICompatibleClient(LLMClient):
    def __init__(self, api_key=None, base_url=None, model="gpt-4o-mini",
                 max_retries=3, retry_delay=1.0):
        super().__init__(api_key, base_url)
        self.model = model
        self.max_retries = max_retries      # æœ€å¤§é‡è¯•æ¬¡æ•°
        self.retry_delay = retry_delay      # åŸºç¡€å»¶è¿Ÿï¼ˆç§’ï¼‰

    def chat(self, messages, temperature=0.7) -> str:
        last_exception = None

        for attempt in range(self.max_retries + 1):
            try:
                # å‘é€ API è¯·æ±‚
                response = client.chat.completions.create(...)
                return response.choices[0].message.content

            except APIStatusError as e:
                status_code = e.status_code

                # 429 é™æµæˆ– 5xx æœåŠ¡å™¨é”™è¯¯ â†’ é‡è¯•
                if status_code in (429, 500, 502, 503, 504):
                    if attempt < self.max_retries:
                        # æŒ‡æ•°é€€é¿ + éšæœºæŠ–åŠ¨
                        delay = self.retry_delay * (2 ** attempt) + random.uniform(0, 1)
                        print(f"[RETRY] é‡åˆ°é™æµ (429)ï¼Œ{delay:.1f}ç§’åé‡è¯•...")
                        time.sleep(delay)
                        continue

                # 4xx å®¢æˆ·ç«¯é”™è¯¯ â†’ ç›´æ¥æŠ›å‡º
                raise

            except APIConnectionError as e:
                # è¿æ¥é”™è¯¯ â†’ é‡è¯•
                if attempt < self.max_retries:
                    delay = self.retry_delay * (2 ** attempt) + random.uniform(0, 1)
                    time.sleep(delay)
                    continue
                raise
```

**é‡è¯•å»¶è¿Ÿè®¡ç®—ç¤ºä¾‹ï¼š**

```
retry_delay = 1.0 (åŸºç¡€å»¶è¿Ÿ)

ç¬¬ 1 æ¬¡é‡è¯•ï¼š1.0 Ã— 2^0 + random(0,1) = 1.0~2.0 ç§’
ç¬¬ 2 æ¬¡é‡è¯•ï¼š1.0 Ã— 2^1 + random(0,1) = 2.0~3.0 ç§’
ç¬¬ 3 æ¬¡é‡è¯•ï¼š1.0 Ã— 2^2 + random(0,1) = 4.0~5.0 ç§’
```

---

## ğŸ“ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        LongNovelProcessor                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Chunking Engine  â”‚     â”‚        VectorMemoryBank             â”‚ â”‚
â”‚  â”‚  - NovelReader    â”‚â”€â”€â”€â”€â–¶â”‚  - CharacterMemoryStore             â”‚ â”‚
â”‚  â”‚  - TextChunk      â”‚     â”‚  - TF-IDF Vectorizer                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  - Cosine Similarity Search         â”‚ â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚                              â”‚
â”‚                                        â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Processing Pipeline                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  Extractor     â”‚â”€â”€â–¶â”‚  Script Gen   â”‚â”€â”€â–¶â”‚ Storyboard Gen  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  (å¸¦è®°å¿†æ³¨å…¥)   â”‚  â”‚  (å¸¦è®°å¿†æ³¨å…¥)  â”‚  â”‚  (å¸¦è®°å¿†æ³¨å…¥)    â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  OpenAICompatibleClient                         â”‚ â”‚
â”‚  â”‚  - HTTP 429/5xx è‡ªåŠ¨é‡è¯•                                        â”‚ â”‚
â”‚  â”‚  - æŒ‡æ•°é€€é¿ + éšæœºæŠ–åŠ¨                                           â”‚ â”‚
â”‚  â”‚  - Connection Error å®¹é”™                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµè½¬

```
å°è¯´æ–‡ä»¶
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. NovelReader   â”‚ æŒ‰ç« èŠ‚åˆ‡åˆ†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. é€ç« å¤„ç†      â”‚
â”‚   â”œâ”€â”€ æå–äººç‰© â”€â”€â–¶ æ·»åŠ åˆ° VectorMemoryBank (å‘é‡åŒ–)
â”‚   â”œâ”€â”€ æå–å…³ç³» â”€â”€â–¶ æ·»åŠ åˆ°å…³ç³»åˆ—è¡¨
â”‚   â””â”€â”€ æå–äº‹ä»¶ â”€â”€â–¶ ç”¨äºå‰§æœ¬ç”Ÿæˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å‰§æœ¬ç”Ÿæˆ      â”‚ ä» VectorMemoryBank æ£€ç´¢ç›¸å…³äººç‰©è®°å¿†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. åˆ†é•œç”Ÿæˆ      â”‚ ä» VectorMemoryBank æ£€ç´¢ç›¸å…³äººç‰©è®°å¿†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
æœ€ç»ˆè¾“å‡º (JSON)
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹

```bash
# 1. å‘é‡è®°å¿†é“¶è¡Œæµ‹è¯•
python -c "
from vector_store import VectorMemoryBank
mb = VectorMemoryBank()
mb.add_character('char1', 'å“ˆåˆ©', ['å‹‡æ•¢'], ['æ‰“è´¥åæ´¾'], ['ä¸»è§’'], ['é»‘å‘'])
context = mb.to_context_prompt('å“ˆåˆ©ä¸æ€ªç‰©æˆ˜æ–—')
print(context)
# è¾“å‡ºï¼šã€ç›¸å…³äººç‰©è®°å¿†ã€‘å“ˆåˆ©...
"

# 2. ScriptGenerator è®°å¿†æ³¨å…¥æµ‹è¯•
python -c "
from script_generator import ScriptGenerator, MockLLMClient
gen = ScriptGenerator(MockLLMClient(mock_response))
scenes = gen.generate([event], memory_context='å“ˆåˆ©æ˜¯é»‘å‘ç»¿çœ¼çš„å·«å¸ˆ')
print(f'ç”Ÿæˆ {len(scenes)} ä¸ªåœºæ™¯')
"

# 3. StoryboardGenerator è®°å¿†æ³¨å…¥æµ‹è¯•
python -c "
from storyboard_generator import StoryboardGenerator
sg = StoryboardGenerator(MockLLMClient(mock_response))
shots = sg.generate(scene, memory_context='å“ˆåˆ©åœ¨åœº')
print(f'ç”Ÿæˆ {len(shots)} ä¸ªé•œå¤´')
"

# 4. é‡è¯•å‚æ•°æµ‹è¯•
python -c "
from extractor import OpenAICompatibleClient
client = OpenAICompatibleClient(max_retries=5, retry_delay=2.0)
print(f'max_retries={client.max_retries}, retry_delay={client.retry_delay}')
"
```

### æµ‹è¯•ç»“æœ

```
============================================================
æµ‹è¯• 1: å‘é‡è®°å¿†é“¶è¡Œæ£€ç´¢
============================================================
ä¸Šä¸‹æ–‡æµ‹è¯•ï¼šé€šè¿‡

============================================================
æµ‹è¯• 2: ScriptGenerator æ”¯æŒè®°å¿†ä¸Šä¸‹æ–‡
============================================================
ScriptGenerator å¸¦ä¸Šä¸‹æ–‡æµ‹è¯•ï¼šé€šè¿‡

============================================================
æµ‹è¯• 3: StoryboardGenerator æ”¯æŒè®°å¿†ä¸Šä¸‹æ–‡
============================================================
StoryboardGenerator å¸¦ä¸Šä¸‹æ–‡æµ‹è¯•ï¼šé€šè¿‡

============================================================
æµ‹è¯• 4: OpenAICompatibleClient é‡è¯•å‚æ•°
============================================================
Extractor é‡è¯•å‚æ•°ï¼šmax_retries=5, retry_delay=2.0
Script é‡è¯•å‚æ•°ï¼šmax_retries=5
Storyboard é‡è¯•å‚æ•°ï¼šmax_retries=5

============================================================
[OK] æ‰€æœ‰æµ‹è¯•é€šè¿‡!
============================================================
```

---

## ğŸ“ æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `vector_store.py` | å‘é‡åŒ–è®°å¿†å­˜å‚¨ä¸æ£€ç´¢æ¨¡å— |
| `REFACTOR_v3.md` | æœ¬æ–‡æ¡£ |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `main.py` | 1. å¯¼å…¥ `VectorMemoryBank`<br>2. `LongNovelProcessor` æ–°å¢ `use_vector_memory` å‚æ•°<br>3. ä¿®æ”¹ `_merge_characters` æ”¯æŒå‘é‡è®°å¿†<br>4. ä¿®æ”¹ `process_chunk` æ³¨å…¥è®°å¿†ä¸Šä¸‹æ–‡ |
| `script_generator.py` | 1. `ScriptGenerator` æ–°å¢ `memory_bank` å‚æ•°<br>2. `generate()` æ–°å¢ `memory_context` å‚æ•°<br>3. `OpenAICompatibleClient` æ·»åŠ é‡è¯•é€»è¾‘ |
| `storyboard_generator.py` | 1. `StoryboardGenerator` æ–°å¢ `memory_bank` å‚æ•°<br>2. `generate()` æ–°å¢ `memory_context` å‚æ•°<br>3. `OpenAICompatibleClient` æ·»åŠ é‡è¯•é€»è¾‘ |
| `extractor.py` | `OpenAICompatibleClient` æ·»åŠ å®Œæ•´é‡è¯•é€»è¾‘ï¼ˆHTTP 429/5xx/Connection Errorï¼‰ |

---

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç”¨æ³•

```python
import os
from main import LongNovelProcessor
from extractor import OpenAICompatibleClient

# é…ç½® LLM å®¢æˆ·ç«¯ï¼ˆå¸¦é‡è¯•ï¼‰
llm_client = OpenAICompatibleClient(
    api_key=os.environ.get("LLM_API_KEY"),
    base_url=os.environ.get("LLM_BASE_URL"),
    model=os.environ.get("LLM_MODEL", "gpt-4o-mini"),
    max_retries=3,           # é‡è¯•æ¬¡æ•°
    retry_delay=1.0          # åŸºç¡€å»¶è¿Ÿï¼ˆç§’ï¼‰
)

# åˆ›å»ºå¤„ç†å™¨ï¼ˆå¯ç”¨å‘é‡è®°å¿†ï¼‰
processor = LongNovelProcessor(
    llm_client=llm_client,
    use_vector_memory=True,  # å¯ç”¨å‘é‡è®°å¿†æ£€ç´¢
    enable_memory_merge=True,
    enable_checkpoint=True
)

# å¤„ç†å°è¯´
result = processor.process_novel(
    file_path="novel.txt",
    output_path="result.json"
)
```

### å‘½ä»¤è¡Œç”¨æ³•

```bash
# å¤„ç†å°è¯´æ–‡ä»¶ï¼ˆé»˜è®¤å¯ç”¨å‘é‡è®°å¿†ï¼‰
python main.py --file novel.txt --output result.json

# ç¦ç”¨å‘é‡è®°å¿†ï¼ˆä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼ï¼‰
python main.py --file novel.txt --output result.json --no-memory-merge

# è‡ªå®šä¹‰é‡è¯•å‚æ•°ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡ï¼‰
export LLM_MAX_RETRIES=5
export LLM_RETRY_DELAY=2.0
python main.py --file novel.txt --output result.json
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¸Šä¸‹æ–‡é•¿åº¦ä¼˜åŒ–

| åœºæ™¯ | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| å¤„ç†ç¬¬ 1 ç«  | ~200 tokens | ~200 tokens |
| å¤„ç†ç¬¬ 10 ç«  | ~2,000 tokensï¼ˆæ‰€æœ‰ç´¯ç§¯äººç‰©ï¼‰ | ~300 tokensï¼ˆä»…ç›¸å…³äººç‰©ï¼‰ |
| å¤„ç†ç¬¬ 50 ç«  | ~10,000 tokensï¼ˆå¯èƒ½è¶…é™ï¼‰ | ~500 tokensï¼ˆç¨³å®šï¼‰ |

### ç”Ÿæˆè´¨é‡æå‡

| æŒ‡æ ‡ | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| äººç‰©å¤–è²Œä¸€è‡´æ€§ | âŒ ç¬¬ 10 ç« åç»å¸¸é”™è¯¯ | âœ“ å§‹ç»ˆæ­£ç¡® |
| äººç‰©å…³ç³»å‡†ç¡®æ€§ | âŒ å®¹æ˜“æ··æ·† | âœ“ å‡†ç¡®å¼•ç”¨ |
| åœºæ™¯æè¿°è¿è´¯æ€§ | âŒ å‰åçŸ›ç›¾ | âœ“ é€»è¾‘ä¸€è‡´ |

---

## ğŸš€ åç»­ä¼˜åŒ–æ–¹å‘

### 1. å‘é‡æ•°æ®åº“å‡çº§

å½“å‰ä½¿ç”¨è½»é‡çº§ TF-IDF å®ç°ï¼Œå¯ä»¥è€ƒè™‘ï¼š
- é›†æˆ `chromadb`ï¼ˆçœŸæ­£çš„å‘é‡æ•°æ®åº“ï¼‰
- ä½¿ç”¨ embedding æ¨¡å‹ï¼ˆå¦‚`text-embedding-3-small`ï¼‰
- æ”¯æŒè¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢

### 2. è®°å¿†åˆ†å±‚ç®¡ç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŸ­æœŸè®°å¿†        â”‚ â† å½“å‰ç« èŠ‚å†…å®¹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸­æœŸè®°å¿†        â”‚ â† æœ€è¿‘ 10 ç« å†…å®¹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é•¿æœŸè®°å¿†        â”‚ â† æ ¸å¿ƒäººç‰©è®¾å®šï¼ˆå‘é‡åŒ–ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. æ™ºèƒ½è®°å¿†å‹ç¼©

- å½“è®°å¿†è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œè‡ªåŠ¨è¿›è¡Œæ‘˜è¦å‹ç¼©
- ä¿ç•™æ ¸å¿ƒä¿¡æ¯ï¼Œä¸¢å¼ƒæ¬¡è¦ç»†èŠ‚
- ç±»ä¼¼äººç±»çš„"é—å¿˜"æœºåˆ¶

---

## ğŸ“ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ |
|------|------|------|
| v3.0 | 2026-02-20 | å‘é‡åŒ–è®°å¿†é‡æ„ç‰ˆï¼ˆæœ¬æ¬¡ï¼‰ |
| v2.0 | - | LLM é©±åŠ¨ç‰ˆ |
| v1.0 | - | åŸºç¡€æ¶æ„ç‰ˆ |

---

## ğŸ’¡ æ ¸å¿ƒè®¾è®¡æ€æƒ³

> "ä¸è¦æŠŠæ‰€æœ‰è®°å¿†éƒ½å¡è¿› Promptï¼Œåªç»™ LLM å®ƒçœŸæ­£éœ€è¦çš„ä¸Šä¸‹æ–‡ã€‚"

### å…³é”®æ´å¯Ÿ

1. **è®°å¿†æ£€ç´¢ > è®°å¿†ç´¯ç§¯**
   - ä¸æ˜¯æŠŠæ‰€æœ‰å†å²éƒ½å¸¦ä¸Šï¼Œè€Œæ˜¯æ ¹æ®å½“å‰å†…å®¹æ™ºèƒ½æ£€ç´¢
   - ç±»ä¼¼äººç±»çš„"è”æƒ³è®°å¿†"æœºåˆ¶

2. **å‘é‡åŒ– > å…³é”®è¯åŒ¹é…**
   - TF-IDF èƒ½å¤Ÿæ•æ‰è¯­ä¹‰ç›¸ä¼¼æ€§
   - "å“ˆåˆ©æ‹”å‰‘"èƒ½å¤Ÿæ£€ç´¢åˆ°"å“ˆåˆ©æ˜¯å·«å¸ˆ"çš„è®°å¿†

3. **å®¹é”™è®¾è®¡ > ç†æƒ³å‡è®¾**
   - ç½‘ç»œä¼šæ³¢åŠ¨
   - API ä¼šé™æµ
   - å¿…é¡»æœ‰é‡è¯•æœºåˆ¶

---

## ğŸ“„ License

MIT License

---

**å¼€å‘å®Œæˆæ—¥æœŸï¼š2026-02-20**
