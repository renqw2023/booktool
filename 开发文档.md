# 自动化小说理解与剧本分镜生成系统

## 项目概述

本项目是一个使用 Python 从零构建的完整『自动化小说理解与剧本分镜生成系统』。系统采用 TDD（测试驱动开发）方式开发，能够将小说文本自动转换为剧本场景和分镜镜头。

## 系统架构

```
小说文本 → 信息提取引擎 → 剧本生成 → 分镜生成 → 输出结果
              ↓
        人物/关系/时间线
```

## 目录结构

```
booktools/
├── models.py                 # 核心数据模型
├── extractor.py              # 信息提取引擎
├── script_generator.py       # 剧本生成模块
├── storyboard_generator.py   # 分镜生成模块
├── main.py                   # 主程序和流水线
├── requirements.md           # 需求文档
├── 开发文档.md               # 本文档
├── test_phase1_models.py     # Phase 1 测试
├── test_phase2_extractor.py  # Phase 2 测试
├── test_phase3_script_generator.py  # Phase 3 测试
├── test_phase4_storyboard.py        # Phase 4 测试
└── test_phase5_pipeline.py          # Phase 5 测试
```

## 环境要求

- Python 3.8+
- pytest (用于运行测试)

## 安装

```bash
pip install pytest
```

## 运行测试

运行所有测试：

```bash
pytest -v
```

运行特定阶段的测试：

```bash
pytest test_phase1_models.py -v
pytest test_phase2_extractor.py -v
pytest test_phase3_script_generator.py -v
pytest test_phase4_storyboard.py -v
pytest test_phase5_pipeline.py -v
```

## 运行程序

```bash
python main.py
```

## 核心模块说明

### 1. 数据模型 (models.py)

#### Character - 人物实体

```python
@dataclass
class Character:
    id: str              # 人物唯一标识
    name: str            # 人物姓名
    description: str     # 人物描述
    traits: List[str]    # 人物特质列表
    goals: List[str]     # 人物目标列表
    background: str      # 背景故事（可选）
    appearance: str      # 外貌描述（可选）
```

#### Relationship - 人物关系

```python
@dataclass
class Relationship:
    id: str              # 关系唯一标识
    character_id_1: str  # 第一个人物 ID
    character_id_2: str  # 第二个人物 ID
    type: str            # 关系类型（朋友/敌人/伙伴等）
    description: str     # 关系描述
    conflict_level: int  # 冲突等级 (0-5)
    strength: int        # 关系强度 (0-5)
```

#### TimelineEvent - 时间线事件

```python
@dataclass
class TimelineEvent:
    id: str              # 事件唯一标识
    chapter: int         # 所属章节
    summary: str         # 事件摘要
    description: str     # 事件详细描述
    character_ids: List[str]  # 相关人物 ID 列表
    location: str        # 事件地点
    timestamp: str       # 时间点（可选）
```

#### ScriptScene - 剧本场景

```python
@dataclass
class ScriptScene:
    id: str              # 场景唯一标识
    chapter: int         # 所属章节
    location: str        # 场景地点
    time: str            # 时间（日/夜/黄昏等）
    description: str     # 场景描述
    dialogues: List[Dict]  # 对白列表
    character_ids: List[str]  # 出场人物
    actions: List[str]   # 动作列表
```

#### StoryboardShot - 分镜镜头

```python
@dataclass
class StoryboardShot:
    id: str              # 镜头唯一标识
    scene_id: str        # 所属场景 ID
    shot_number: int     # 镜头编号
    shot_type: str       # 镜头类型（全景/中景/近景/特写）
    description: str     # 镜头描述
    camera_direction: str    # 镜头指示（可选）
    duration_seconds: float  # 持续时间（可选）
    audio_direction: str     # 音频指示（可选）
    characters_in_shot: List[str]  # 镜头中的人物
```

### 2. 信息提取引擎 (extractor.py)

#### CharacterExtractor - 人物提取器

从小说文本中自动提取人物信息，包括：
- 人物姓名识别
- 人物特质提取（如"性格坚毅"、"为人聪明"）
- 人物描述生成

```python
extractor = CharacterExtractor()
characters = extractor.extract(novel_text)
```

#### RelationshipExtractor - 关系提取器

分析人物之间的关系：
- 朋友/伙伴/敌人关系识别
- 关系强度评估
- 冲突等级判断

```python
extractor = RelationshipExtractor()
relationships = extractor.extract(novel_text)
```

#### TimelineExtractor - 时间线提取器

提取故事时间线：
- 章节识别和分割
- 事件摘要生成
- 地点信息提取

```python
extractor = TimelineExtractor()
events = extractor.extract(novel_text)
```

### 3. 剧本生成模块 (script_generator.py)

#### ScriptGenerator - 剧本生成器

将时间线事件转换为剧本场景：
- 场景时间判定（日/夜）
- 场景地点设定
- 场景描述生成

```python
generator = ScriptGenerator()
scenes = generator.generate(timeline_events)
```

### 4. 分镜生成模块 (storyboard_generator.py)

#### StoryboardGenerator - 分镜生成器

将剧本场景拆解为分镜镜头：
- 建立镜头（全景）
- 对白镜头（近景/特写）
- 动作镜头（中景）

```python
generator = StoryboardGenerator()
shots = generator.generate(script_scene)
```

### 5. 系统流水线 (main.py)

#### NovelProcessor - 小说处理器

整合所有模块，提供一站式处理流程：

```python
processor = NovelProcessor()
result = processor.process(novel_text)

# 返回结果包含：
# - characters: 人物列表
# - relationships: 关系列表
# - timeline_events: 时间线事件
# - script_scenes: 剧本场景
# - storyboard_shots: 分镜镜头
```

## 使用示例

### 完整流程示例

```python
from main import NovelProcessor

# 小说文本
novel_text = """
第一章：初遇

张三是一个年轻的剑客，性格坚毅。
在一个雨夜，张三走进了小镇的酒馆。

第二章：结伴

李四是个神秘的商人，为人聪明。
张三和李四决定一起踏上旅程。
他们成为了伙伴。
"""

# 创建处理器并执行
processor = NovelProcessor()
result = processor.process(novel_text)

# 输出结果
print(f"人物数量：{len(result['characters'])}")
print(f"关系数量：{len(result['relationships'])}")
print(f"场景数量：{len(result['script_scenes'])}")
print(f"分镜数量：{len(result['storyboard_shots'])}")
```

### 单独使用提取器

```python
from extractor import CharacterExtractor

extractor = CharacterExtractor()
text = "张三是一个年轻的剑客，性格坚毅，为人正直。"
characters = extractor.extract(text)

for char in characters:
    print(f"人物：{char.name}")
    print(f"特质：{char.traits}")
```

### 单独使用分镜生成器

```python
from storyboard_generator import StoryboardGenerator
from models import ScriptScene

generator = StoryboardGenerator()
scene = ScriptScene(
    id="scene_001",
    chapter=1,
    location="酒馆 - 内部",
    time="夜",
    description="昏暗的酒馆，张三走向柜台",
    dialogues=[
        {"character_id": "char_张三", "line": "老板，来杯酒"}
    ]
)

shots = generator.generate(scene)
for shot in shots:
    print(f"{shot.shot_type}: {shot.description}")
```

## 测试覆盖

| 模块 | 测试类 | 测试数量 |
|------|--------|----------|
| models.py | TestCharacter, TestRelationship, TestTimelineEvent, TestScriptScene, TestStoryboardShot | 10 |
| extractor.py | TestCharacterExtractor, TestRelationshipExtractor, TestTimelineExtractor | 7 |
| script_generator.py | TestScriptGenerator | 5 |
| storyboard_generator.py | TestStoryboardGenerator | 6 |
| main.py | TestNovelProcessor | 5 |
| **总计** | | **33** |

## 开发历史

本项目严格按照 TDD 方式，分 5 个阶段开发完成：

1. **Phase 1**: 核心数据结构定义 - 使用 dataclass 定义 5 个核心实体
2. **Phase 2**: 信息提取引擎 - 实现人物、关系、时间线的提取
3. **Phase 3**: 剧本生成模块 - 将事件转换为剧本场景
4. **Phase 4**: 分镜生成模块 - 将场景拆解为分镜镜头
5. **Phase 5**: 系统流水线整合 - 串联所有模块，实现端到端处理

## 扩展建议

### 功能扩展

1. **增强提取能力**
   - 集成 LLM 进行更准确的人物和关系提取
   - 支持更多关系类型（师徒、兄弟姐妹等）
   - 支持情感分析

2. **输出格式**
   - 支持导出为 PDF 剧本格式
   - 支持导出为视频编辑软件可用格式
   - 支持 JSON/XML 导出

3. **可视化**
   - 人物关系图生成
   - 时间线可视化
   - 分镜预览图生成

### 性能优化

1. 支持批量处理长篇小说
2. 添加缓存机制避免重复计算
3. 支持增量更新

## 许可证

MIT License
